!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Monitor=t()}(this,function(){"use strict";var e={ADD_DATA:{},ERROR_LIST:[],beginTime:0,loadTime:0,ajaxTime:0,fetchTime:0,reportFn:void 0,reportTimeOutHandler:void 0};const t={domain:"http://localhost/api",outTime:500,filterUrl:[],isPage:!0,isAjax:!0,isResource:!0,isError:!0,add:{}},r={t:"",n:"js",msg:"",data:{}},o={resourceList:[],performance:{},errorList:[],fetchLoadNum:0,ajaxLoadNum:0,ajaxLength:0,fetchLength:0,ajaxMsg:{},goingType:"",haveAjax:!1,haveFetch:!1,preUrl:document.referrer&&document.referrer!==location.href?document.referrer:"",page:""};var n={randomString:function(e=10){const t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz123456789",r=t.length;let o="";for(let n=0;n<e;n++)o+=t.charAt(Math.floor(Math.random()*r));return o+(new Date).getTime()}};function a(t=0){window.performance&&window.performance.clearResourceTimings&&window.performance.clearResourceTimings(),o.performance={},o.errorList=[],o.preUrl="",o.resourceList=[],o.page=0===t?window.location.href:"",o.haveAjax=!1,o.haveFetch=!1,o.ajaxMsg={},e.ERROR_LIST=[],e.ADD_DATA={},e.ajaxTime=0,e.fetchTime=0}function i(){const e=new Date;let t=localStorage.getItem("ps_markUv")||"";const r=localStorage.getItem("ps_markUvTime")||"",o=`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()} 23:59:59`;return(!t&&!r||e.getTime()>1*r)&&(t=n.randomString(),localStorage.setItem("ps_markUv",t),localStorage.setItem("ps_markUvTime",new Date(o).getTime())),t}const s=function(r=1,s={}){const c=e.reportFn;e.reportTimeOutHandler=setTimeout(()=>{t.isPage&&function(){if(!window.performance)return;let e=window.performance.timing;o.performance={dnst:e.domainLookupEnd-e.domainLookupStart||0,tcpt:e.connectEnd-e.connectStart||0,wit:e.responseStart-e.navigationStart||0,domt:e.domContentLoadedEventEnd-e.navigationStart||0,lodt:e.loadEventEnd-e.navigationStart||0,radt:e.fetchStart-e.navigationStart||0,rdit:e.redirectEnd-e.redirectStart||0,uodt:e.unloadEventEnd-e.unloadEventStart||0,reqt:e.responseEnd-e.requestStart||0,andt:e.domComplete-e.domInteractive||0}}(),(t.isResource||t.isAjax)&&function(){if(!window.performance||!window.performance.getEntries)return!1;const e=window.performance.getEntriesByType("resource"),r=[];if(!e&&!e.length)return r;e.forEach(e=>{if(!t.isAjax&&("xmlhttprequest"==e.initiatorType||"fetchrequest"==e.initiatorType))return;if(!t.isResource&&"xmlhttprequest"!=e.initiatorType&&"fetchrequest"!==e.initiatorType)return;const n={name:e.name,method:"GET",type:e.initiatorType,duration:e.duration.toFixed(2)||0,decodedBodySize:e.decodedBodySize||0,nextHopProtocol:e.nextHopProtocol},a=e.name?e.name.split("?")[0]:"",i=o.ajaxMsg[a]||"";i&&(n.method=i.method||"GET",n.type=i.type||n.type,n.decodedBodySize=n.decodedBodySize||i.decodedBodySize),r.push(n)}),o.resourceList=r}(),e.ERROR_LIST.length&&(o.errorList=o.errorList.concat(e.ERROR_LIST));const s=function(){let e=sessionStorage.getItem("ps_markUser")||"";const t={markUser:e,isFristIn:!1};return e||(e=n.randomString(),sessionStorage.setItem("ps_markUser",e),t.markUser=e,t.isFristIn=!0),t}();let d={time:(new Date).getTime(),addData:e.ADD_DATA,markUser:s.markUser,markUv:i(),type:r,url:window.location.href};!function(){const e=o.resourceList||[];let r=t.filterUrl||[],n=[];if(e.length&&r.length)for(let t=0;t<e.length;t++){let o=!1;for(let n=0;n<r.length;n++)if(e[t].name.indexOf(r[n])>-1){o=!0;break}o||n.push(e[t])}o.resourceList=n}(),1===r?d=Object.assign(d,{preUrl:o.preUrl,errorList:o.errorList,performance:o.performance,resourceList:o.resourceList,isFristIn:s.isFristIn,screenwidth:document.documentElement.clientWidth||document.body.clientWidth,screenheight:document.documentElement.clientHeight||document.body.clientHeight}):2===r?d=Object.assign(d,{resourceList:o.resourceList,errorList:o.errorList}):3===r&&(d=Object.assign(d,{errorList:o.errorList,resourceList:o.resourceList})),d=Object.assign(d,t.add),c&&c(d),c&&c(d).then(e=>{}).catch(e=>{}),!c&&window.fetch&&fetch(t.domain,{method:"POST",headers:{"Content-Type":"application/json"},type:"report-data",body:JSON.stringify(d)}).then(e=>{}).catch(e=>{}),e.reportTimeOutHandler=void 0,Promise.resolve().then(()=>{a()})},t.outTime)};function c(t){window.performance&&window.performance.clearResourceTimings&&(o.haveAjax&&o.haveFetch&&0==o.ajaxLength&&0==o.fetchLength?a(1):!o.haveAjax&&o.haveFetch&&0==o.fetchLength?a(1):o.haveAjax&&!o.haveFetch&&0==o.ajaxLength&&a(1)),e.reportTimeOutHandler&&clearTimeout(e.reportTimeOutHandler)}function d(){const{loadTime:t,ajaxTime:r,fetchTime:n}=e;o.page!==location.href?o.haveAjax&&o.haveFetch&&t&&r&&n?s(1):o.haveAjax&&!o.haveFetch&&t&&r?s(1):!o.haveAjax&&o.haveFetch&&t&&n?s(1):o.haveAjax||o.haveFetch||!t||s(1):o.haveAjax&&o.haveFetch&&r&&n?s(2):o.haveAjax&&!o.haveFetch&&r?s(2):!o.haveAjax&&o.haveFetch&&n&&s(2)}function h(t){o.fetchLoadNum+=1,e.reportTimeOutHandler&&clearTimeout(e.reportTimeOutHandler),o.fetchLength===o.fetchLoadNum&&(o.fetchLoadNum=o.fetchLength=0,e.fetchTime=(new Date).getTime()-e.beginTime,d())}function u(t){o.ajaxLoadNum+=1,o.ajaxLoadNum===o.ajaxLength&&(o.ajaxLength=o.ajaxLoadNum=0,e.ajaxTime=(new Date).getTime()-e.beginTime,d())}function l(e,t){let n=Object.assign({},r);n.t=(new Date).getTime(),n.n="ajax",n.msg=e.statusText||"ajax request error",n.method=e.method,n.data={resourceUrl:e.responseURL,text:e.statusText,status:e.status},o.errorList.push(n)}function m(e){const t={method:"GET",type:"fetchrequest"},r=Array.prototype.slice.apply(e);if(!r||!r.length)return t;try{1===r.length?"string"==typeof r[0]?t.url=r[0]:"object"==typeof r[0]&&(t.url=r[0].url,t.method=r[0].method):(t.url=r[0],t.method=r[1].method||"GET",t.type=r[1].type||"fetchrequest")}catch(e){}return t}var f=function(e,t){return e(t={exports:{}},t.exports),t.exports}(function(e){var t,r;t=e.exports,r="RealXMLHttpRequest",t.hookAjax=function(e){function t(t){return function(){var r=this.hasOwnProperty(t+"_")?this[t+"_"]:this.xhr[t],o=(e[t]||{}).getter;return o&&o(r,this)||r}}function o(t){return function(r){var o=this.xhr,n=this,a=e[t];if("function"==typeof a)o[t]=function(){e[t](n)||r.apply(o,arguments)};else{var i=(a||{}).setter;r=i&&i(r,n)||r;try{o[t]=r}catch(e){this[t+"_"]=r}}}}function n(t){return function(){var r=[].slice.call(arguments);if(!e[t]||!e[t].call(this,r,this.xhr))return this.xhr[t].apply(this.xhr,r)}}return window[r]=window[r]||XMLHttpRequest,XMLHttpRequest=function(){var e=new window[r];for(var a in e){var i="";try{i=typeof e[a]}catch(e){}"function"===i?this[a]=n(a):Object.defineProperty(this,a,{get:t(a),set:o(a),enumerable:!0})}this.xhr=e},window[r]},t.unHookAjax=function(){window[r]&&(XMLHttpRequest=window[r]),window[r]=void 0},t.default=t});var p;return(p=Object.freeze({default:function(n,a){e.beginTime=(new Date).getTime(),e.loadTime=0,e.ajaxTime=0,e.fetchTime=0,e.reportFn=a;Object.assign(t,n),t.filterUrl=t.filterUrl.concat(["livereload.js?snipver=1","/sockjs-node/","hm.baidu.com"],[t.domain]),t.isError&&function(e){window.addEventListener("error",function(e){const t=Object.assign({},r);t.n="resource",t.t=(new Date).getTime(),t.msg=e.target.localName+" is load error",t.method="GET",t.data={target:e.target.localName,type:e.type,resourceUrl:e.target.href||e.target.currentSrc},e.target!=window&&o.errorList.push(t)},!0),window.onerror=function(t,n,a,i,s){const c=Object.assign({},r);setTimeout(function(){i=i||window.event&&window.event.errorCharacter||0,c.msg=s&&s.stack?s.stack.toString():t,c.method="GET",c.data={resourceUrl:n,line:a,col:i},c.t=(new Date).getTime(),o.errorList.push(c),o.page!==location.href||o.haveAjax||e(3)},0)},window.addEventListener("unhandledrejection",function(t){const n=t&&t.reason,a=n.message||"";let i,s,c,d=(n.stack||"").match(/\(.+?\)/);d&&d.length&&(d=d[0]),(d=(d=d.replace(/\w.+[js|html]/g,e=>(i=e,""))).split(":"))&&d.length>1&&(c=parseInt(d[1]||0)),s=parseInt(d[2]||0);let h=Object.assign({},r);h.msg=a,h.method="GET",h.t=(new Date).getTime(),h.data={resourceUrl:i,line:s,col:c},o.errorList.push(h),o.page!==location.href||o.haveAjax||e(3)});const t=console.error;console.error=function(o){const n=Object.assign({},r);return setTimeout(function(){n.msg=o,n.method="GET",n.t=(new Date).getTime(),n.data={resourceUrl:location.href},conf.errorList.push(n),conf.page!==location.href||conf.haveAjax||e(3)},0),t.apply(console,arguments)}}(a),window.addEventListener("load",function(){e.loadTime=(new Date).getTime()-e.beginTime,d()},!1),(t.isAjax||t.isError)&&function(){if(!window.fetch)return;const e=fetch;window.fetch=function(){const t=arguments,n=m(t);if("report-data"!==n.type){c();const e=n.url?n.url.split("?")[0]:"";o.ajaxMsg[e]=n,o.fetchLength=o.fetchLength+1,o.haveFetch=!0}return e.apply(this,arguments).then(e=>{if("report-data"===n.type)return e;try{const t=e.url?e.url.split("?")[0]:"";e.clone().text().then(e=>{o.ajaxMsg[t]&&(o.ajaxMsg[t].decodedBodySize=e.length)})}catch(e){}return h(),e}).catch(e=>{if("report-data"===n.type)throw e;h();let t=Object.assign({},r);throw t.t=(new Date).getTime(),t.n="fetch",t.msg="fetch request error",t.method=n.method,t.data={resourceUrl:n.url,text:e.stack||e,status:0},o.errorList.push(t),e})}}(),(t.isAjax||t.isError)&&f.hookAjax({onreadystatechange:function(e){4===e.readyState&&setTimeout(()=>{if("load"===o.goingType)return;o.goingType="readychange";const t=e.xhr.responseURL?e.xhr.responseURL.split("?")[0]:"";if(o.ajaxMsg[t]){try{e.xhr.response instanceof Blob?o.ajaxMsg[t].decodedBodySize=e.xhr.response.size:o.ajaxMsg[t].decodedBodySize=e.xhr.responseText.length}catch(e){}u()}(e.status<200||e.status>300)&&(e.method=e.args.method,l(e))},600)},onerror:function(e){const t={};e.args&&(t.method=e.args.method,t.responseURL=e.args.url,t.statusText="ajax request error",o.ajaxMsg[t.responseURL]&&u()),l(Object.assign({},e,t))},onload:function(e){if(4===e.readyState){if("readychange"===o.goingType)return;o.goingType="load";const t=e.xhr.responseURL?e.xhr.responseURL.split("?")[0]:"";if(o.ajaxMsg[t]){try{e.xhr.response instanceof Blob?o.ajaxMsg[t].decodedBodySize=e.xhr.response.size:o.ajaxMsg[t].decodedBodySize=e.xhr.responseText.length}catch(e){}u()}(e.status<200||e.status>300)&&(e.method=e.args.method,l(e))}},open:function(e,r){if(t.filterUrl&&t.filterUrl.length){let r=!1;if(t.filterUrl.forEach(t=>{-1!=e[1].indexOf(t)&&(r=!0)}),r)return}let n={url:e[1].split("?")[0],method:e[0]||"GET",type:"xmlhttprequest"};this.args=n,c(),o.ajaxMsg[n.url]=n,o.ajaxLength=o.ajaxLength+1,o.haveAjax=!0}})}}))&&p.default||p});
